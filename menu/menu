#!/bin/bash

# =============================================
# COLOR DEFINITIONS (Optimized for readability)
# =============================================
clear
# Base Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Background Colors
BG_RED='\033[41m'
BG_GREEN='\033[42m'
BG_YELLOW='\033[43m'

# =============================================
# SYSTEM INFORMATION (Complete)
# =============================================
get_system_info() {
    MODEL=$(grep -w PRETTY_NAME /etc/os-release | cut -d= -f2 | tr -d '"')
    IPVPS=$(curl -s ipv4.icanhazip.com || echo "Unknown")
    DOMAIN=$(cat /etc/xray/domain 2>/dev/null || echo "Not configured")
    UPTIME=$(uptime -p | sed 's/up //')
    DATEVPS=$(date +'%d-%m-%Y')
    TIMEZONE=$(date +'%H:%M:%S')
    ISP=$(cat /root/.info/.isp 2>/dev/null || echo "Unknown")
    CITY=$(cat /root/.info/.city 2>/dev/null || echo "Unknown")
    
    # Resource usage in MB
    TOTAL_RAM=$(free -m | awk '/Mem:/ {print $2}')
    USED_RAM=$(free -m | awk '/Mem:/ {print $3}')
    RAM_PERCENT=$(free | awk '/Mem:/ {printf("%.1f%%", $3/$2*100)}')
    CPU_LOAD=$(top -bn1 | awk '/Cpu/ {printf "%.1f%%", 100 - $8}')
    CPU_CORES=$(nproc)
}

# =============================================
# LICENSE CHECK (Complete)
# =============================================
check_license() {
    LICENSE_CHECK_URL="https://raw.githubusercontent.com/remkenceng/pokemon/main/izin/ip"
    MYIP=$(curl -sS ipv4.icanhazip.com || echo "0.0.0.0")
    LICENSE_INFO=$(curl -s "$LICENSE_CHECK_URL" | grep "$MYIP" || echo "")
    
    USERNAME=$(echo "$LICENSE_INFO" | awk '{print $1}')
    [ -z "$USERNAME" ] && USERNAME="Unknown"
    
    EXPIRY_DATE=$(echo "$LICENSE_INFO" | awk '{print $5}')
    [ -z "$EXPIRY_DATE" ] && EXPIRY_DATE="Unlimited"
    
    if [ "$EXPIRY_DATE" == "Unlimited" ]; then
        STATUS="${GREEN}Unlimited${NC}"
        CERTIFICATE="∞ Days"
    else
        TODAY=$(date +"%d-%m-%Y")
        EXPIRY_SEC=$(date -d "$(echo "$EXPIRY_DATE" | awk -F'-' '{print $3"-"$2"-"$1}')" +%s 2>/dev/null)
        TODAY_SEC=$(date -d "$(echo "$TODAY" | awk -F'-' '{print $3"-"$2"-"$1}')" +%s 2>/dev/null)
        
        if [ -z "$EXPIRY_SEC" ] || [ -z "$TODAY_SEC" ]; then
            STATUS="${RED}Invalid${NC}"
            CERTIFICATE="N/A"
        else
            SECONDS_LEFT=$((EXPIRY_SEC - TODAY_SEC))
            if [ $SECONDS_LEFT -lt 0 ]; then
                STATUS="${RED}Tidak Berlangganan${NC}"
                CERTIFICATE="0 Days"
            else
                DAYS_LEFT=$(( (SECONDS_LEFT + 86399) / 86400 ))
                STATUS="${GREEN}Berlangganan${NC}"
                CERTIFICATE="$DAYS_LEFT Hari"
            fi
        fi
    fi
}

# =============================================
# SERVICE MANAGEMENT (Complete)
# =============================================
check_service() {
    if systemctl is-active --quiet "$1"; then
        echo -e "${GREEN}🟢 RUNNING${NC}"
    else
        echo -e "${RED}🔴 STOPPED${NC}"
    fi
}

get_service_status() {
    SSH_STATUS=$(check_service ssh)
    NGINX_STATUS=$(check_service nginx)
    XRAY_STATUS=$(check_service xray)
    WSEPRO_STATUS=$(check_service ws)
    DROPBEAR_STATUS=$(check_service dropbear)
    HAPROXY_STATUS=$(check_service haproxy)
}

# =============================================
# ACCOUNT STATISTICS (Complete)
# =============================================
get_account_stats() {
    SSH_COUNT=$(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd | wc -l)
    
    if [ -f "/etc/xray/config.json" ]; then
        VMESS_COUNT=$(( $(grep -c -E "^### " "/etc/xray/config.json") / 2 ))
        VLESS_COUNT=$(( $(grep -c -E "^#& " "/etc/xray/config.json") / 2 ))
        TROJAN_COUNT=$(( $(grep -c -E "^#! " "/etc/xray/config.json") / 2 ))
        SHADOWSOCKS_COUNT=$(( $(grep -c -E "^#ss# " "/etc/xray/config.json") / 2 ))
    else
        VMESS_COUNT=0
        VLESS_COUNT=0
        TROJAN_COUNT=0
        SHADOWSOCKS_COUNT=0
    fi
}

# =============================================
# DISPLAY FUNCTIONS (Optimized for readability)
# =============================================
display_header() {
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════╗"
    echo -e "║ ${YELLOW}POKEMON TUNNELING HORE - PREMIUM EDITION${BLUE}                 ║"
    echo -e "╠══════════════════════════════════════════════════════════╣"
    echo -e "║ ${CYAN}OS${NC}     : ${WHITE}$MODEL${BLUE}"
    echo -e "║ ${CYAN}ISP${NC}    : ${WHITE}$ISP${BLUE}"
    echo -e "║ ${CYAN}CITY${NC}   : ${WHITE}$CITY${BLUE}"
    echo -e "║ ${CYAN}IP${NC}     : ${WHITE}$IPVPS${BLUE}"
    echo -e "║ ${CYAN}DOMAIN${NC} : ${WHITE}$DOMAIN${BLUE}"
    echo -e "║ ${CYAN}DATE${NC}   : ${WHITE}$DATEVPS${BLUE}"
    echo -e "║ ${CYAN}UPTIME${NC} : ${WHITE}$UPTIME${BLUE}"
    echo -e "║ ${CYAN}RAM${NC}    : ${WHITE}${USED_RAM}MB / ${TOTAL_RAM}MB (${RAM_PERCENT})${BLUE}"
    echo -e "║ ${CYAN}CPU${NC}    : ${WHITE}${CPU_LOAD} (${CPU_CORES} Cores)${BLUE}"
    echo -e "╚══════════════════════════════════════════════════════════╝"
}

display_services() {
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════╗"
    echo -e "║ ${YELLOW}SERVICES STATUS${BLUE}                                          ║"
    echo -e "╠══════════════════════════════════════════════════════════╣"
    echo -e "║ ${CYAN}SSH${NC}      : $SSH_STATUS${BLUE}"
    echo -e "║ ${CYAN}NGINX${NC}    : $NGINX_STATUS${BLUE}"
    echo -e "║ ${CYAN}XRAY${NC}     : $XRAY_STATUS${BLUE}"
    echo -e "║ ${CYAN}WS-ePRO${NC}  : $WSEPRO_STATUS${BLUE}"
    echo -e "║ ${CYAN}DROPBEAR${NC} : $DROPBEAR_STATUS${BLUE}"
    echo -e "║ ${CYAN}HAPROXY${NC}  : $HAPROXY_STATUS${BLUE}"
    echo -e "╚══════════════════════════════════════════════════════════╝"
}

display_accounts() {
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════╗"
    echo -e "║ ${YELLOW}INFORMATION STATISTICS${BLUE}                                   ║"
    echo -e "╠══════════════════════════════════════════════════════════╣"
    echo -e "║ ${CYAN}SSH/OVPN${NC}    : ${WHITE}$SSH_COUNT${BLUE}"
    echo -e "║ ${CYAN}VMESS${NC}       : ${WHITE}$VMESS_COUNT${BLUE}"
    echo -e "║ ${CYAN}VLESS${NC}       : ${WHITE}$VLESS_COUNT${BLUE}" 
    echo -e "║ ${CYAN}TROJAN${NC}      : ${WHITE}$TROJAN_COUNT${BLUE}"
    echo -e "║ ${CYAN}SHADOWSOCKS${NC} : ${WHITE}$SHADOWSOCKS_COUNT${BLUE}"
    echo -e "╚══════════════════════════════════════════════════════════╝"
}

display_license() {
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════╗"
    echo -e "║ ${YELLOW}LICENSE INFORMATION${BLUE}                                      ║"
    echo -e "╠══════════════════════════════════════════════════════════╣"
    echo -e "║ ${CYAN}Username${NC}   : ${WHITE}$USERNAME${BLUE}"
    echo -e "║ ${CYAN}Ip${NC}         : ${WHITE}$IPVPS${BLUE}"
    echo -e "║ ${CYAN}Expired${NC}    : ${WHITE}$EXPIRY_DATE${BLUE}"
    echo -e "║ ${CYAN}Hari${NC}       : ${WHITE}$CERTIFICATE${BLUE}"
    echo -e "║ ${CYAN}Lisensi${NC}    : $STATUS"
    echo -e "${BLUE}╚══════════════════════════════════════════════════════════╝"
}

display_menu() {
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════╗"
    echo -e "║ ${YELLOW}TUNNELING SERVICES${BLUE}                                       ║"
    echo -e "╠══════════════════════════════════════════════════════════╣"
    echo -e "║ ${WHITE}[1]${NC} ${CYAN}SSH Menu${BLUE}"                           
    echo -e "║ ${WHITE}[2]${NC} ${CYAN}VMESS Menu${BLUE}"                        
    echo -e "║ ${WHITE}[3]${NC} ${CYAN}VLESS Menu${BLUE}"                            
    echo -e "║ ${WHITE}[4]${NC} ${CYAN}TROJAN Menu${BLUE}"                        
    echo -e "║ ${WHITE}[5]${NC} ${CYAN}SSWS Menu${BLUE}"                            
    echo -e "║ ${WHITE}[6]${NC} ${CYAN}HOKAGEVPN Menu${BLUE}"                       
    echo -e "║ ${WHITE}[7]${NC} ${CYAN}SPEEDTEST${BLUE}"                             
    echo -e "║ ${WHITE}[8]${NC} ${CYAN}UTILITIES${BLUE}"                              
    echo -e "║ ${WHITE}[0]${NC} ${RED}EXIT${BLUE}"                         
    echo -e "╚══════════════════════════════════════════════════════════╝"
}

# =============================================
# MAIN EXECUTION
# =============================================
main() {
    get_system_info
    check_license
    get_account_stats
    get_service_status
    
    clear
    display_header
    display_services
    display_accounts
    display_license
    display_menu
    
    read -p "$(echo -e "${WHITE}PILIH OPSI INI [1-8] : ${NC}")" opt
    case $opt in
        1|01) clear; m-sshws ;;
        2|02) clear; m-vmess ;;
        3|03) clear; m-vless ;;
        4|04) clear; m-trojan ;;
        5|05) clear; m-ssws ;;
        6|06) clear; m-noob ;;
        7|07) clear; speedtest ;;
        8|08) clear; menu-x ;;
        0|00) echo -e "${RED}Exiting...${NC}"; exit 0 ;;
        *) echo -e "${RED}Invalid option!${NC}"; sleep 1; clear; main ;;
    esac
}

main