#!/bin/bash

# Check Unicode support
if [ "$(locale charmap 2>/dev/null)" = "UTF-8" ] && 
   [ -n "$(echo -e '\U1F7E2\U1F534' | grep -vF 'U1F7E')" ]; then
    ICON_ACTIVE="🟢"
    ICON_INACTIVE="🔴"
    ICON_OK="✓"
    ICON_ERROR="✗"
    ICON_WARNING="⚠"
    ICON_INFO="ℹ"
else
    ICON_ACTIVE="[ACTIVE]"
    ICON_INACTIVE="[INACTIVE]"
    ICON_OK="[OK]"
    ICON_ERROR="[ERROR]"
    ICON_WARNING="[WARN]"
    ICON_INFO="[INFO]"
fi

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
WHITE='\033[1;37m'
NC='\033[0m'

BG_RED='\033[41m'
BG_GREEN='\033[42m'
BG_YELLOW='\033[43m'

get_system_info() {
    MODEL=$(grep -w PRETTY_NAME /etc/os-release | cut -d= -f2 | tr -d '"')
    IPVPS=$(curl -s ipv4.icanhazip.com || echo "Unknown")
    DOMAIN=$(cat /etc/xray/domain 2>/dev/null || echo "Not configured")
    UPTIME=$(uptime -p | sed 's/up //')
    DATEVPS=$(date +'%d-%m-%Y')
    TIMEZONE=$(date +'%H:%M:%S')
    ISP=$(cat /root/.info/.isp 2>/dev/null || echo "Unknown")
    CITY=$(cat /root/.info/.city 2>/dev/null || echo "Unknown")
    
    TOTAL_RAM=$(free -m | awk '/Mem:/ {print $2}')
    USED_RAM=$(free -m | awk '/Mem:/ {print $3}')
    RAM_PERCENT=$(free | awk '/Mem:/ {printf("%.1f%%", $3/$2*100)}')
    CPU_LOAD=$(top -bn1 | awk '/Cpu/ {printf "%.1f%%", 100 - $8}')
    CPU_CORES=$(nproc)
}

check_license() {
    LICENSE_CHECK_URL="https://raw.githubusercontent.com/remkenceng/pokemon/main/izin/ip"
    MYIP=$(curl -sS ipv4.icanhazip.com || echo "0.0.0.0")
    LICENSE_INFO=$(curl -s "$LICENSE_CHECK_URL" | grep "$MYIP" || echo "")
    
    USERNAME=$(echo "$LICENSE_INFO" | awk '{print $1}')
    [ -z "$USERNAME" ] && USERNAME="Unknown"
    
    EXPIRY_DATE=$(echo "$LICENSE_INFO" | awk '{print $5}')
    [ -z "$EXPIRY_DATE" ] && EXPIRY_DATE="Unlimited"
    
    if [ "$EXPIRY_DATE" == "Unlimited" ]; then
        STATUS="${GREEN}${ICON_OK} Unlimited${NC}"
        CERTIFICATE="∞ Days"
    else
        TODAY=$(date +"%d-%m-%Y")
        EXPIRY_SEC=$(date -d "$(echo "$EXPIRY_DATE" | awk -F'-' '{print $3"-"$2"-"$1}')" +%s 2>/dev/null)
        TODAY_SEC=$(date -d "$(echo "$TODAY" | awk -F'-' '{print $3"-"$2"-"$1}')" +%s 2>/dev/null)
        
        if [ -z "$EXPIRY_SEC" ] || [ -z "$TODAY_SEC" ]; then
            STATUS="${RED}${ICON_ERROR} Invalid${NC}"
            CERTIFICATE="N/A"
        else
            SECONDS_LEFT=$((EXPIRY_SEC - TODAY_SEC))
            if [ $SECONDS_LEFT -lt 0 ]; then
                STATUS="${RED}${ICON_ERROR} Tidak Berlangganan${NC}"
                CERTIFICATE="0 Days"
            else
                DAYS_LEFT=$(( (SECONDS_LEFT + 86399) / 86400 ))
                STATUS="Berlangganan"
                CERTIFICATE="$DAYS_LEFT"
            fi
        fi
    fi
}

check_service() {
    if systemctl is-active --quiet "$1"; then
        echo -e "${GREEN}${ICON_ACTIVE} RUNNING${NC}"
    else
        echo -e "${RED}${ICON_INACTIVE} STOPPED${NC}"
    fi
}

get_service_status() {
    SSH_STATUS=$(check_service ssh)
    NGINX_STATUS=$(check_service nginx)
    XRAY_STATUS=$(check_service xray)
    WSEPRO_STATUS=$(check_service ws)
    DROPBEAR_STATUS=$(check_service dropbear) 
    HAPROXY_STATUS=$(check_service haproxy)
}

get_account_stats() {
    SSH_COUNT=$(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd | wc -l)
    
    if [ -f "/etc/xray/config.json" ]; then
        VMESS_COUNT=$(( $(grep -c -E "^### " "/etc/xray/config.json") / 2 ))
        VLESS_COUNT=$(( $(grep -c -E "^#& " "/etc/xray/config.json") / 2 ))
        TROJAN_COUNT=$(( $(grep -c -E "^#! " "/etc/xray/config.json") / 2 ))
        SHADOWSOCKS_COUNT=$(( $(grep -c -E "^### ss " "/etc/xray/config.json") / 2 ))
    else
        VMESS_COUNT=0
        VLESS_COUNT=0
        TROJAN_COUNT=0
        SHADOWSOCKS_COUNT=0
    fi
}

display_header() {
    echo -e "${CYAN}═════════════════════════════════════════════════════════════${NC}"
    echo -e " • ${CYAN}Operating System${NC}  : ${WHITE}$MODEL"
    echo -e " • ${CYAN}Isp Provider${NC}      : ${WHITE}$ISP" 
    echo -e " • ${CYAN}Kota${NC}              : ${WHITE}$CITY"
    echo -e " • ${CYAN}Ip${NC}                : ${WHITE}$IPVPS"
    echo -e " • ${CYAN}Domain${NC}            : ${WHITE}$DOMAIN"
    echo -e " • ${CYAN}Ram${NC}               : ${WHITE}${USED_RAM}MB | ${TOTAL_RAM}MB [${RAM_PERCENT}]"
    echo -e " • ${CYAN}Cpu${NC}               : ${WHITE}${CPU_LOAD} [${CPU_CORES} Cores]"
    echo -e " • ${CYAN}Date${NC}              : ${WHITE}$DATEVPS"
    echo -e " • ${CYAN}Uptime${NC}            : ${WHITE}$UPTIME"
}

display_accounts() {
    echo -e "${CYAN}═════════════════════════════════════════════════════════════${NC}"
    echo -e " • ${CYAN}SSH/OVPN${NC}    : ${WHITE}$SSH_COUNT"
    echo -e " • ${CYAN}VMESS${NC}       : ${WHITE}$VMESS_COUNT"
    echo -e " • ${CYAN}VLESS${NC}       : ${WHITE}$VLESS_COUNT"
    echo -e " • ${CYAN}TROJAN${NC}      : ${WHITE}$TROJAN_COUNT"
    echo -e " • ${CYAN}SHADOWSOCKS${NC} : ${WHITE}$SHADOWSOCKS_COUNT"
}


display_services() {
    echo -e "${CYAN}═════════════════════════════════════════════════════════════${NC}"
    echo -e " • ${CYAN}SSH${NC}      : $SSH_STATUS"
    echo -e " • ${CYAN}NGINX${NC}    : $NGINX_STATUS"
    echo -e " • ${CYAN}XRAY${NC}     : $XRAY_STATUS"
    echo -e " • ${CYAN}WS-ePRO${NC}  : $WSEPRO_STATUS"
    echo -e " • ${CYAN}DROPBEAR${NC} : $DROPBEAR_STATUS"
    echo -e " • ${CYAN}HAPROXY${NC}  : $HAPROXY_STATUS"
}

display_license() {
    echo -e "${CYAN}═════════════════════════════════════════════════════════════${NC}"
    echo -e " • ${CYAN}Lisensi${NC}    : ${PURPLE}$USERNAME"${NC}
    echo -e " • ${CYAN}Ip${NC}         : ${YELLOW}$IPVPS"${NC}
    echo -e " • ${CYAN}Expired${NC}    : ${GREEN}$EXPIRY_DATE${NC} ${RED}|-_-|${NC} ${GREEN}$CERTIFICATE Hari${NC}"
} 

display_menu() {
    echo -e "${CYAN}═════════════════════════════════════════════════════════════${NC}"
    echo -e " • ${WHITE}[1] SSH-WS${NC}        ${WHITE}[5] SODOSOK-WS${NC}"
    echo -e " • ${WHITE}[2] VMESS${NC}         ${WHITE}[6] NOOBZVPNS${NC}"
    echo -e " • ${WHITE}[3] VLESS${NC}         ${WHITE}[7] SPEEDTEST${NC}"
    echo -e " • ${WHITE}[4] TROJAN${NC}        ${WHITE}[8] UTILITIES${NC}"
    echo -e "${CYAN}═════════════════════════════════════════════════════════════${NC}"
}

main() {
    export LANG=en_US.UTF-8 2>/dev/null
    export LC_ALL=en_US.UTF-8 2>/dev/null
    
    get_system_info
    check_license
    get_account_stats
    get_service_status
    
    clear
    display_header
    display_accounts
    display_services
    display_license
    display_menu
    echo ""
    read -p "$(echo -e "${WHITE}PILIH OPSI [ 1-8 | X TO EXIT] : ${NC}")" opt
    case $opt in
        1|01) clear; m-sshws ;;
        2|02) clear; m-vmess ;;
        3|03) clear; m-vless ;;
        4|04) clear; m-trojan ;;
        5|05) clear; m-ssws ;;
        6|06) clear; m-noob ;;
        7|07) clear; speedtest ;;
        8|08) clear; menu-x ;;
        x|00) echo -e "${RED}${ICON_INFO} Exiting ..... !!!${NC}"; exit 0 ;;
        *) echo -e "${RED}${ICON_ERROR} Inputan Tidak Diketahui ..... !!!${NC}"; sleep 1; clear; main ;;
    esac
}

main